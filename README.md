# DeNovoCNN

A deep learning approach to call de novo mutations (DNMs) on whole-exome (WES) and whole-genome sequencing (WGS) data. DeNovoCNN uses trio recalibrated BAM/CRAM + VCF (or tab-separated list of variants) files to generate image-like genomic sequence representations and detect DNMs with high accuracy. <br>
<br>
DeNovoCNN is a combination of three models for the calling of substitution, deletion and insertion DNMs. Each of the model is a 9-layers CNN with [squeeze-and-excitation](https://arxiv.org/pdf/1709.01507.pdf) blocks. DeNovoCNN is trained on ~16k manually curated DNM and IV (inherited and non-DNM variants) sequencing data, generated using [Illumina](https://www.illumina.com/) sequencer and [Sureselect Human
All Exon V5](https://www.agilent.com/cs/library/datasheets/public/AllExondatasheet-5990-9857EN.pdf)/[Sureselect Human
All Exon V4](https://www.agilent.com/cs/library/flyers/Public/5990-9857en_lo.pdf) capture kits.  <br>
<br>
DeNovoCNN returns a tab-separated file of format:
> Chromosome | Start position | End position | Reference | Variant | DNM posterior probability | Mean coverage 

We used **DNM posterior probability >= 0.5** to create a filtered tab-separated file with the list of variants that are likely to be *de novo*.

## How does it work?

DeNovoCNN reads BAM files and iterates through potential DNM locations using the input VCF files to generate snapshots of genomic regions. It stacks trio BAM files to generate and RGB image representation which are passed into a CNN with squeeze-and-excitation blocks to classify each image as either DNM or IV (inherited variant, non-DNM).<br>
<br>
Images are similar to the one that you see below. Each color represents different trio individuals: red - child; green - father; blue - mother. In the example you can see a clear red signal (child reads) in the central position which in this case is a de novo deletion.<br>


<img src="data/del_dnm.png" alt="drawing" width="420px" height="420px"/>


## Manual installation
We advise to use our docker container. In case it's not possible, the easiest way of installing is creating an [Anaconda](https://www.anaconda.com/) environment. Dockerized version coming up.

```bash
#Create environment 
cd .../DeNovoCNN
RUN conda env create -f environment.yml
```

## Usage

```bash
    cd .../DeNovoCNN
```

### Prediction
To use the pretrained models, you can provide the paths to the models from 'models' folder. 

<b>Important: denovoCNN expects recallibrated BAM files using BQSR, more [here](https://gatk.broadinstitute.org/hc/en-us/articles/360035890531-Base-Quality-Score-Recalibration-BQSR-).</b> VCF files can be generated using your preffered variant caller.<br>

If you're running denovoCNN on WGS data, it is recommended to split the VCF files or variants of interest into 10 or more parts and run each of them separately and if possible in parallel. The separation could be done using the following commands:
```bash
   bcftools isec -C $BGZIPPED_CHILD_VCF $BGZIPPED_FATHER_VCF $BGZIPPED_MOTHER_VCF > all_variants.txt
   split -d -l 10000 --additional-suffix=.txt all_variants.txt part_variants

```
The resulting list of variants could be passed as `-v` parameter. <br>
<br>
To run DeNovoCNN on all possible locations: 
```bash
./apply_denovocnn.sh \
-w=<WORKING_DIRECTORY> \
-cv=<CHILD_VCF> \
-fv=<FATHER_VCF> \
-mv=<MOTHER_VCF> \
-cb=<CHILD_BAM> \
-fb=<FATHER_BAM> \
-mb=<MOTHER_BAM> \
-sm=<SNP_MODEL> \
-im=<INSERTION_MODEL> \
-dm=<DELETION_MODEL> \
-g=<REFERENCE_GENOME> \
-o=predictions.csv
```

To run DeNovoCNN on a specified list (VARIANT_LIST_TSV) of locations:

```bash
./apply_denovocnn.sh \
-w=<WORKING_DIRECTORY> \
-v=<VARIANT_LIST_TSV>
-cb=<CHILD_BAM> \
-fb=<FATHER_BAM> \
-mb=<MOTHER_BAM> \
-sm=<SNP_MODEL> \
-im=<INSERTION_MODEL> \
-dm=<DELETION_MODEL> \
-g=<REFERENCE_GENOME> \
-o=predictions.csv
```
VARIANT_LIST_TSV is a tab-separated file of format:
> Chromosome | Start position | Reference | Variant | Additional info

It could be generated by filtering the locations of interest of the result of this command:

```bash
   bcftools isec -C $BGZIPPED_CHILD_VCF $BGZIPPED_FATHER_VCF $BGZIPPED_MOTHER_VCF > all_variants_list.txt
```

### Docker

DeNovoCNN is available as a docker container. 

The example of DeNovoCNN usage for prediction:
```bash
docker run \
  -v "YOUR_INPUT_DIRECTORY":"/input" \
  -v "YOUR_OUTPUT_DIRECTORY:/output" \
  gelana/denovocnn: \
  /app/apply_denovocnn.sh\
    -w=/output \
    -cv=/input/<CHILD_VCF> \
    -fv=/input/<FATHER_VCF> \
    -mv=/input/<MOTHER_VCF> \
    -cb=/input/<CHILD_BAM> \
    -fb=/input/<FATHER_BAM> \
    -mb=/input/<MOTHER_BAM> \
    -sm=/input/<SNP_MODEL> \
    -im=/input/<INSERTION_MODEL> \
    -dm=/input/<DELETION_MODEL> \
    -g=/input/<REFERENCE_GENOME> \
    -o=predictions.csv
```
Parameters description and usage are described earlier in the previous section. 
## License
[GNU GPLv3](https://choosealicense.com/licenses/gpl-3.0/)

Copyright (c) 2021 Karolis Sablauskas <br>
Copyright (c) 2021 Gelana Khazeeva
